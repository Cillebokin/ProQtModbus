# Modbus规格书

## 一、简介

本系统是在了解熟悉Modbus TCP和Modbus RTU的相关知识点后，完成的基于TCP模式的Modbus主站以及基于RTU模式的Modbus从站，在实现通信功能后能够做到读写寄存器，以及读写线圈的相关操作，同时为用户提供操作界面，以便于功能的使用。

## 二、编写目的

为了确保本系统的设计与开发工作得以顺利进行，特将本系统的规格需求以及开发工作中所涉及的相关问题以书面形式加以约定，以此作为系统开发工作的基础性文件，任何开发过程中所遇到的问题与矛盾均以此文档的内容为核心参考目标，以便根据文档内容展开设计开发以及后续的检查工作。

在本文档，将首先从使用者对系统的需求角度出发，对相关的需求进行功能性分析，以确定本系统的设计方向与开发限制。

## 三、规格介绍

* 开发环境：QT 5.4.0
* 开发语言：C++
* 通信方式：TCP/IP、串行链路通信
* 软件使用环境：Windows10
* 协议复刻：Modbus TCP、Modbus RTU
* 从机编号：0x01 ~ 0xF7 （247个）
* 可使用的功能码：（4个）
  * 0x01：读取多线圈
  * 0x03：读取多寄存器
  * 0x0F：写入多线圈
  * 0x10：写入多寄存器

| 功能码 |      功能说明      |
| :----: | :----------------: |
|  0x01  |    读取输出线圈    |
|  0x03  |   读取输出寄存器   |
|  0x0F  |  写入多个输出线圈  |
|  0x10  | 写入多个输出寄存器 |

* 线圈编号：0x0001 ~ 0x270F 即 00001 ~ 09999（9999个）
* 寄存器编号：0x0001 ~ 0x270F 即 00001 ~ 09999（9999个）

| 区号 |    名称    | 读写性 |    范围     |
| :--: | :--------: | :----: | :---------: |
|  0   |  输出线圈  | 可读写 | 00001-09999 |
|  4   | 输出寄存器 | 可读写 | 00001-09999 |

## 四、功能描述



### 1.TCP主站

#### （1）网络连接部分

* 用户可自行填写需要连接的IP地址、端口号，若不填写则系统默认设置IP为127.0.0.1，Port为502，IP输入框的输入内容被限定为IP地址格式的0 - 255的数字字符串，端口号输入框的输入范围为0 - 65535，设置完成后，完成网络通信相关连接参数的设置。
* 为用户提供连接按钮，当网络连接未完成时，按钮文本显示“开始连接”，并连接正在侦听的网络中；当连接成功后，按钮文本显示“停止连接”，并实现网络连接功能；再次点击按钮，则文本显示为“开始连接”，并自动断开网络连接。
* 当网络连接断开时，包括主站自身断开，以及从站停止侦听，按钮自动恢复成未连接的状态，并提示用户连接已断开，此时无法通过网络发送或接收数据。
* 为用户提供消息显示界面，以显示网络连接过程中的相关信息。当成功连接后显示文本“已成功连接”，并显示对方的IP地址；当断开连接后，显示文本“已断开连接”。
* 完成网络连接后，用户可通过网络向从机发送请求报文。
* 完成网络连接后，用户可通过网络获取到由从机发来的响应报文。

#### （2）操作控件初始化

* 为用户提供LineEdit输入从机地址，当用户未输入时，从机地址框显示提示数据1 -247，同时输入框的可输入内容仅为0到9的数字字符，且范围在1 - 247之间，若超出范围则无法被输入。当LineEdit内容为NULL时，默认设置为0x01。
* 为用户提供下拉框ComboBox，包括可选择的四个功能码（0x01/0x03/0x0F/0x10），默认选择为0x01。
* 为用户提供LineEdit输入起始地址，当用户未输入时，起始地址框显示提示数据1 - 9999，同时输入框的可输入内容仅为0到9的数字字符，且范围在1-9999之间，若超出范围则无法被输入，当LineEdit内容为NULL时，默认设置为0x01。
* 为用户提供LineEdit输入数量，当用户未输入时，数量框显示提示数据对应的数据，当LineEdit内容为NULL时，默认设置为0x01。同时输入框的可输入内容仅为0 - 9的数字字符，且范围随着用户选择的功能码的变化而变化，当功能码为0x01时，输入范围为1 - 2000；当功能码为0x03时，输入范围为1 - 125；当功能码为0x0F时，输入范围为1 - 1968；当功能码为0x10时，输入范围为1 - 123。
* 为用户提供LineEdit输入具体数据，数据框显示提示数据Hex，表示需要输入十六进制数，当用户选择功能码为0x01和0x03时，LineEdit不提供编辑功能，无法输入数据；当用户选择功能码为0x0F和0x10时，则LineEdit向用户开放编辑功能，可输入内容为0 - 9、A - F，以及a - f的字符。

#### （3）数据显示部分

* 用户界面中提供用于显示数据的表格，表格内容包括编号、地址、数据，行数为10000。
* 表格分为显示线圈数据的表格以及用于显示寄存器数据的表格，表中数据初始化为0。
* 显示线圈数据的地址列，由编号1到9999的地址十六进制形式对应为0x0001 - 0x270f。
* 显示寄存器数据的地址列，由编号1到9999的地址十六进制形式，且不会在线圈的基础上加40000，对应地址依然为0x0001 - 0x270f。
* 当通过网络获取到新的响应报文后，经过解析，获取其中的数据并实时更新显示在表格当中。
* 用户需要从主站写入线圈或寄存器的数据时，可通过修改表格中的数据，线圈数据表的数据仅能存储1和0，若输入0则保存为0；若输入为非0的数则保存为1；若输入非数字字符，则保存为0；若输入为NULL，则保存为0。
* 指定写入的相关参数后，打包报文的数据项会从表格中获取。

#### （4）数据发送部分

* 当用户完成网络连接，并且填写了相应的数据后，可点击按钮，完成对报文数据的封装及发送。
* 按钮的触发槽函数中，获取当前设置的从机地址、功能码、起始地址、数量，以及数据，若是功能码不为0x0F或0x10，则不包括具体数据。
* 若是包括数据项，则将用户输入的在数据表中的相关数据，修改成数据形式，作为数据项一起封装在完整的报文中。
* 编辑TCP报头内容，包括请求报文的编号（请求一次，编号自增）、Modbus协议标识（00 00表示Modbus协议），并统计后段字节数。
* 根据不同的功能码，对应不同的格式，将相关的数据封装成一个完整的报文，存储在QByteArray类型中，单个字类型设置为quint8。
* 随后将QByteArray，作为请求报文，通过TCP网络发送给从机。

#### （5）数据接收部分

* 当请求报文发送后，记录该请求，并等待从机的响应报文。
* 通过网络接收从机发来的报文。
* 对接收到的报文做初步分析：
  * 若主机未发送请求报文，却收到了报文，则视为无用报文，并在消息显示界面提示用户。
  * 若主机发送了请求，且收到了报文，则判断其报文QByteArray长度是否为符合标准的长度，若是小于该长度，则在消息显示界面提示用户，其为无效。
  * 若长度符合标准，则与此前记录的请求报文做比对，确定从机编号和协议标识与请求报文是否一致。
  * 若符合上述要求，则进行进一步的报文解析。
* 对接收到的数据进行解析：
  * 首先区分该功能码是否为标准的功能码，若不符合标准则解析结束，返回0x01，并在消息显示界面提示用户。
  * 其次，判定响应报文的数量项是否符合对应功能码的要求，如0x01为1 - 2000，0x03为1 - 125，0x0F为1 - 1968，0x10为1 - 123。若不符合则解析结束，返回0x03，并在消息显示界面提示用户。
  * 随后，判定起始地址是否合法，以及起始地址加上数量是否符合要求，若不正确，则解析结束，返回0x02，并在消息显示界面提示用户。
  * 若完成上述要求，则将QByteArray中的数据项截取后转换为QString存储。
* 最终，将解析出的数据，根据不同的功能码做出不同的操作，读则将解析数据显示在表格中为用户展示，写则确认响应报文是否正确。
* 解析完成后，清除所记录的请求报文内容。

### 2.RTU从站

#### （1）网络连接部分

* 用户可自行填写需要连接的串口号、波特率、数据位、校验位、和停止位，若不填写则系统默认设置COM为20，波特率为9600，数据位为8，校验位为偶校验位，停止位为1，以完成网络通信相关连接参数的设置。
* 为用户提供连接按钮，当串口连接未完成时，按钮文本显示“开始连接”，并尝试连接串口；当连接成功后，按钮文本显示“停止连接”，并实现网络连接；再次点击按钮，则文本显示为“开始连接”，并自动断开串口连接。
* 为用户提供消息显示界面，以显示网络连接过程中的相关信息。当串口连接连接成功后显示文本“已成功连接”并显示对方的串口号；当断开连接后，显示文本“已断开连接”。
* 完成串口连接后，用户可通过串口从主站发接收请求报文。
* 完成串口连接后，用户可通过串口由从站向主站回应响应报文。

#### （2）从站编号部分

* 为用户提供LinEdit输入框，显示提示信息1 - 247，表示用户可自行输入本站的从站编号，未输入时默认设置为1。
* 提供设置按钮，点击按钮后触发槽函数，将当前从站编号设置为用户设置的值，设置成功后，在消息显示界面提示用户已设置成功，以及当前的从站编号。

#### （3）数据操作部分

* 从站客户端软件加载时，自动读取ini中的线圈及寄存器数据，并显示在数据表中。

* 为用户提供用于操作数据的线圈数据表格和寄存器数据表格，分为地址列和数据列，地址列根据线圈1 - 9999和寄存器1 - 9999的十六进制形式显示，不可编辑。数据列可由用户自行编辑数据，限定为线圈为0或1，寄存器为十进制数，在-32768到32767之间的范围。
* 表格数据均初始化为0。
* 当用户修改了数据表中的数据时，ini文件中对应的数据也会相应地发生改变。
* ini文件数据改变后，更新数据表中的内容。

#### （4）CRC校验部分

* 提供CRC校验类，计算基于RTU的CRC16报文校验码。
* 对于接收到的请求报文，计算其报文最后两个字节的校验码与此前报文数据的CRC校验是否一致。
* 对于发送的响应报文，将所有的数据进行CRC校验，计算其校验码，最终将计算结果添加在发送报文之后。

#### （5）报文接收部分

* 可通过串口接收到由主站发来的请求报文。
* 通过QByteArray记录其报文内容，暂时存储。
* 对请求报文初步分析：
  * 对接收到的报文检测基本长度，若基础长度为达到标准，则判定为无用报文。
  * 符合基本长度后，对报文计算其CRC16校验码，并与报文中的校验码进行匹配。
  * 判断请求的从机是否是本机。
  * 判断功能码是否符合正常范围。
  * 若上述要求完成后，则对报文做数据解析。
* 对接收到的数据进行解析：
  * 首先区分该功能码是否为标准的功能码，若不符合标准则解析结束，返回0x01，并在消息显示界面提示用户。
  * 其次，判定响应报文的数量项是否符合对应功能码的要求，如0x01为1 - 2000，0x03为1 - 125，0x0F为1 - 1968，0x10为1 - 123。若不符合则解析结束，返回0x03，并在消息显示界面提示用户。
  * 随后，判定起始地址是否合法，以及起始地址加上数量是否符合要求，若不正确，则解析结束，返回0x02，并在消息显示界面提示用户。
  * 若完成上述要求，则将QByteArray中的数据项截取后转换为QString存储。

#### （6）请求响应部分

* 根据请求报文的内容，区分其功能性：
  * 若是读取数据，则从数据表格中获取对应的内容。
  * 若是写入数据，则从报文中截取对应的数据项。
* 更新数据表的同时，一并修改ini文件中的对应数据。
* 完成后，将QByteArray中所记录的报文内容与数据项按照响应报文的格式进行重新封装。
* 对报文内容进行CRC校验，并附加在报文其后。
* 最终通过串口，将响应报文返回给主站。
* 清空QByteArry内容。并继续等待下一次请求。

## 五、报文请求与响应格式

### 1. 0x01

发送报文格式如下：

| 从站地址 | 功能码 | 起始地址(高) | 起始地址(低) | 数量(高) | 数量(低) |  校验  |
| :------: | :----: | :----------: | :----------: | :------: | :------: | :----: |
|   0x01   |  0x01  |     0x00     |     0x13     |   0x00   |   0x1B   |  XXXX  |
|  1 byte  | 1 byte |    1 byte    |    1 byte    |  1 byte  |  1 byte  | 2 byte |

报文含义：

读取1号从站的输出线圈，起始地址为0x0013 = 19，对应地址为00020，线圈数量为0x001B = 27，即读取1号从站输出线圈，地址从00020 - 00046，共27个线圈的状态值。

返回报文格式如下：

| 从站地址 | 功能码 | 字节数 | 字节1  | 字节2  | 字节3  | 字节4  | 字节... |  校验  |
| :------: | :----: | :----: | :----: | :----: | :----: | :----: | :-----: | :----: |
|   0x01   |  0x01  |  0x04  |  0xCD  |  0x6B  |  0xB2  |  0x05  |  0x...  |  XXXX  |
|  1 byte  | 1 byte | 1 byte | 1 byte | 1 byte | 1 byte | 1 byte | 1 byte  | 2 byte |

返回报文含义：

返回1号从站输出线圈00020 - 00046，共27个线圈的状态值，返回字节数为4个，分别为CD 6B B2 05。

CD = 1100 1101 对应 00020 - 00027

6B = 0110 1011 对应 00028 - 00035

B2 = 1011 0010 对应 00036 - 00043

05 = 0000 0101 对应 00044 - 00046

### 2. 0x03

发送报文格式如下：

| 从站地址 | 功能码 | 起始地址(高) | 起始地址(低) | 数量(高) | 数量(低) |  校验  |
| :------: | :----: | :----------: | :----------: | :------: | :------: | :----: |
|   0x01   |  0x03  |     0x00     |     0x6B     |   0x00   |   0x02   |  XXXX  |
|  1 byte  | 1 byte |    1 byte    |    1 byte    |  1 byte  |  1 byte  | 2 byte |

发送报文含义：

读取1号从站的输出寄存器，起始地址为0x006B = 107，对应地址为40108（40001 + 107），寄存器数量为0x0002 = 2，即读取1号从站输出寄存器，地址从40108 - 40109，共两个寄存器的值。

返回报文格式如下：

| 从站地址 | 功能码 | 字节数 | 寄存器1(高) | 寄存器1(低) | 寄存器2(高) | 寄存器2(低) |  校验  |
| :------: | :----: | :----: | :---------: | :---------: | :---------: | :---------: | :----: |
|   0x01   |  0x03  |  0x04  |    0x02     |    0x2B     |    0x01     |    0x06     |  XXXX  |
|  1 byte  | 1 byte | 1 byte |   1 byte    |   1 byte    |   1 byte    |   1 byte    | 2 byte |

返回报文含义：

返回1号从站输出寄存器40108 - 40109，共两个寄存器的值，返回字节数为4个，分别为02 2B 01 06。

40108寄存器对应数值为0x022B

40108寄存器对应数值为0x0106

### 3. 0x0F

发送报文格式如下：

| 从站地址 | 功能码 | 起始地址(高) | 起始地址(低) | 数量(高) | 数量(低) | 字节数 | 设定值1 | 设定值2 | 校验   |
| :------: | :----: | :----------: | :----------: | :------: | :------: | :----: | :-----: | :-----: | ------ |
|   0x01   |  0x0F  |     0x00     |     0x13     |   0x00   |   0x0A   |  0x02  |  0xCD   |  0X00   | XXXX   |
|  1 byte  | 1 byte |    1 byte    |    1 byte    |  1 byte  |  1 byte  | 1 byte | 1 byte  | 1 byte  | 2 byte |

发送报文含义：

写入1号从站多个线圈的值，线圈地址为0x0013 = 19，对应地址为00020，线圈数为0x000A = 10，写入值为0xCD00，即写入1号从站线圈00020 - 00027对应0xCD = 1100 1101，00028 - 00029对应0x00 = 00。

返回报文格式如下：

| 从站地址 | 功能码 | 起始地址(高) | 起始地址(低) | 数量(高) | 数量(低) |  校验  |
| :------: | :----: | :----------: | :----------: | :------: | :------: | :----: |
|   0x01   |  0x0F  |     0x00     |     0x13     |   0x00   |   0x0A   |  XXXX  |
|  1 byte  | 1 byte |    1 byte    |    1 byte    |  1 byte  |  1 byte  | 2 byte |

返回报文含义：

写入多线圈返回报文是在原报文的基础上去除字节数及具体字节后返回。

### 4. 0x10

发送报文格式如下：

| 从站地址 | 功能码 | 起始地址(高) | 起始地址(低) | 数量(高) | 数量(低) | 字节数 |    字节    |  校验  |
| :------: | :----: | :----------: | :----------: | :------: | :------: | :----: | :--------: | :----: |
|   0x01   |  0x10  |     0x00     |     0x87     |   0x00   |   0x02   |  0x04  | 0x01050A10 |  XXXX  |
|  1 byte  | 1 byte |    1 byte    |    1 byte    |  1 byte  |  1 byte  | 1 byte |   N byte   | 2 byte |

发送报文含义：

写入1号从站多个寄存器的值，寄存器的地址为0x0087 = 135，起始地址为40136（40001 + 135），寄存器数量为0x0002 = 2，则结束地址为40137，写入值为0x0105和0x0A10，即写入1号从站寄存器40136为0x0105，而40137为0x0A10。

返回报文格式如下：

| 从站地址 | 功能码 | 起始地址(高) | 起始地址(低) | 数量(高) | 数量(低) | 校验 |
| :------: | :----: | :----------: | :----------: | :------: | :------: | :--: |
|   0x01   |  0x10  |     0x00     |     0x87     |   0x00   |   0x02   | XXXX |

返回报文含义：

写入多寄存器返回报文是在原报文的基础上去除字节数及具体的字节后返回。

